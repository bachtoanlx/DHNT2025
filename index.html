<!doctype html>
<html>
<head>
   <meta charset="utf-8">
   <title>ESP Control & Logs</title>
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <style>
 :root{
   --bg:#273668;
   --card:#121834;
   --muted:#9aa3b2;
   --text:#eaf0ff;
   --accent:#6ea8fe;
   --success:#29c07e;
   --danger:#ff5b6e;
   --border:rgba(255,255,255,.08);
   --shadow:0 10px 30px rgba(0,0,0,.25);
   --radius:16px;
 }
 *{box-sizing:border-box}
 html,body{height:100%}
 body{
   margin:0; padding:5px;
   font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
   color:var(--text);
   background:
  radial-gradient(1200px 600px at 10% -10%, #1a245a 0%, transparent 40%),
  radial-gradient(1200px 600px at 100% 0%, #0e6b91 0%, transparent 40%),
  var(--bg);
 }
 .container{ max-width:980px; margin:0 auto; padding-bottom: 75px; display:none; }
 h3{ margin:0 0 18px; font-size:28px; letter-spacing:.2px; }

 /* Thêm style cho badge trạng thái online/offline */
 .badge.offline{
   background: rgba(255, 91, 110, 0.12);
   border-color: rgba(255, 91, 110, 0.35);
   color: var(--danger);
 }
 .badge.online{
   background: rgba(41, 192, 126, 0.15);
   border-color: rgba(41, 192, 126, 0.35);
   color: var(--success);
 }

 /* Stats cards */
 .stats{ display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; margin-bottom:14px; }
 .stat{
   background: var(--card); border:1px solid var(--border);
   border-radius: var(--radius); padding:14px; box-shadow: var(--shadow);
   display:flex; flex-direction:column; gap:6px; min-height:82px;
 }
 .stat .label{font-size:12px; color:var(--muted); text-transform: uppercase; letter-spacing:.6px}
 .stat .value{font-size:22px; font-weight:700}

 /* Badges */
 .badge{
   display:inline-block; padding:4px 10px; border-radius:999px;
   background:rgba(255,255,255,.06); border:1px solid var(--border);
   font-size:12px; font-weight:600; letter-spacing:.3px;
 }
 .badge.on{ background: rgba(41,192,126,.15); border-color: rgba(41,192,126,.35); color: var(--success);}
 .badge.off{ background: rgba(255,91,110,.12); border-color: rgba(255,91,110,.35); color: var(--danger);}
 .badge.auto{ background: rgba(110,168,254,.12); border-color: rgba(110,168,254,.35); color: var(--accent);}
 .badge.manual{ background: rgba(255,255,255,.08); color: var(--text);}

 /* Actions */
 .actions{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0; }
 button{
   appearance:none; border:1px solid var(--border); background: var(--card);
   color:var(--text); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
   transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
   box-shadow: var(--shadow);
 }
 button:hover{ transform: translateY(-1px);}
 /* Hiệu ứng khi các nút bị vô hiệu hóa */
 button:disabled {
   cursor: not-allowed;
   opacity: 0.5;
   transform: none;
   box-shadow: none;
 }

 .btn-primary{ background: linear-gradient(180deg, #3478f6, #2463e7); border-color: transparent;}
 .btn-danger{ background: linear-gradient(180deg, #ff6b7a, #e54259); border-color: transparent;}
 .btn-secondary{ background: linear-gradient(180deg, #2b335e, #232a50);}
 .btn-outline{ background: transparent; }

 /* Table */
 .table-wrap{ background: var(--card); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow:auto;}
 table{ width:100%; border-collapse: separate; border-spacing:0; min-width:720px;}
 thead th{
   position: sticky; top:0; z-index:1;
   background: rgba(255,255,255,.06); backdrop-filter: blur(6px);
   font-size:12px; color:var(--muted); text-transform: uppercase; letter-spacing:.6px;
 }
 th, td{ padding:10px 12px; border-bottom:1px solid var(--border); text-align:center;}
 tbody tr:hover{ background: rgba(255,255,255,.04);}
 tbody tr:last-child td{ border-bottom:none;}

    /* Style cho biểu đồ */
    .chart-container {
      width: 100%;
      height: 400px;
      margin: 20px auto; /* Thêm margin để tách khỏi các phần khác */
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }


 /* Login overlay */
 .login-overlay{
   position:fixed; inset:0; background:rgba(0,0,0,.7);
   display:flex; justify-content:center; align-items:center;
   z-index:1000;
 }
 .login-box{
   background:var(--card); padding:24px; border-radius:var(--radius);
   box-shadow:var(--shadow); width:300px; text-align:center;
 }
 .login-box h2{margin:0 0 16px;}
 .login-box input{
   width:90%; padding:10px; margin:6px 0;
   border:1px solid var(--border); border-radius:8px;
   background:#0f1533; color:var(--text);
 }
 .login-box button{width:100%; margin-top:10px;}
 #login-msg{color:var(--danger); font-size:13px; margin-top:8px;}


 footer {
   position: fixed;
   bottom: 0;
   left: 50%;
   transform: translateX(-50%);
   max-width: 980px;
   width: 100%;
   text-align: center;
   padding: 8px 0;
   background-color: #121834;
   color: #eee8e8;
   font-size: 13px;
   border-radius: 8px;
   box-shadow: var(--shadow);
   line-height: 1.3;
 }
 footer p {
   margin: 2px 0;
 }
   </style>
</head>
<body>
   <div class="login-overlay" id="loginScreen">
 <div class="login-box">
   <h2>WiFi Login</h2>
   <input type="text" id="ssid" placeholder="SSID WiFi"><br>
   <input type="password" id="password" placeholder="Mật khẩu WiFi"><br>
   <button class="btn-primary" onclick="doLogin()">Đăng nhập</button>
   <p id="login-msg"></p>
 </div>
   </div>

   <div class="container" id="mainApp">
 <h3 style="display:flex; justify-content:space-between; align-items:center;">
   ESP8266 Monitor & Control (ĐH Nha Trang 2025)
   <span id="status" class="badge">Checking...</span>
   <button class="btn-outline" onclick="logout()" style="float:right;">Logout</button>
 </h3>

 <div class="stats">
   <div class="stat"><div class="label">Temp</div><div class="value"><span id="temp">-</span> °C</div></div>
   <div class="stat"><div class="label">Hum</div><div class="value"><span id="hum">-</span> %</div></div>
   <div class="stat"><div class="label">Soil</div><div class="value"><span id="soil">-</span> %</div></div>
   <div class="stat"><div class="label">Pump</div><div class="value"><span id="pump" class="badge">-</span></div></div>
   <div class="stat"><div class="label">Mode</div><div class="value"><span id="mode" class="badge">-</span></div></div>
 </div>

 <div class="actions">
   <button class="btn-primary" onclick="sendCmd('ON')">Pump ON</button>
   <button class="btn-danger"   onclick="sendCmd('OFF')">Pump OFF</button>
   <button class="btn-secondary" onclick="setMode('Auto')">Mode Auto</button>
   <button class="btn-secondary" onclick="setMode('Manual')">Mode Manual</button>
   <button class="btn-outline"   onclick="exportLogCSV()">Export Logs</button>
 </div>

<!-- START: Phần thêm mới cho thanh trượt -->
<h4 style="margin:14px 0 10px;">Ngưỡng Tự động Tưới (%)</h4>
<div class="slider-container">
  <div class="slider-item">
    <label for="lowThreshSlider">Ngưỡng Thấp (<span id="lowThreshValue">10</span>%)</label>
    <input type="range" id="lowThreshSlider" min="0" max="100" value="10">
  </div>
  <div class="slider-item">
    <label for="highThreshSlider">Ngưỡng Cao (<span id="highThreshValue">50</span>%)</label>
    <input type="range" id="highThreshSlider" min="0" max="100" value="50">
  </div>
</div>
<!-- END: Phần thêm mới cho thanh trượt -->

 <h4 style="margin:14px 0 10px;">Recent Logs</h4>
 <div class="table-wrap">
   <table>
  <thead>
    <tr>
   <th>Time</th>
   <th>Temp</th>
   <th>Hum</th>
   <th>Soil</th>
   <th>Pump</th>
   <th>Mode</th>
   <th>Note</th>
    </tr>
  </thead>
  <tbody id="logTable">
    <tr><td colspan="7">Loading...</td></tr>
  </tbody>
   </table>
 </div>

    <!-- Biểu đồ được chèn vào đây -->
    <h4 style="margin:14px 0 10px;">Daily Chart</h4>
    <div class="chart-container">
      <canvas id="dailyChart"></canvas>
    </div>
   </div>

<footer>
   <p>© 2025 Chuyên đề Tốt nghiệp Đại học Nha Trang 2025</p>
   <p>GVHD: Tiến sĩ - Nguyễn Thanh Tuấn</p>
   <p>SVHT: Bạch Văn Toàn | 24DT1133 & Đặng Hoàng Nhã | 24DT1120</p>
</footer>

<script>
//Thông tin WiFi cố định (giống ESP)
const WIFI_USER = "admin";
const WIFI_PASS = "admin@2025";

// Sửa hàm doLogin để nhận đối tượng sự kiện và ngăn form gửi đi
function doLogin(e){
  e.preventDefault(); // Ngăn trang tải lại
   const u = document.getElementById("ssid").value;
   const p = document.getElementById("password").value;
   if(u===WIFI_USER && p===WIFI_PASS){
      localStorage.setItem("logged","1");
      document.getElementById("loginScreen").style.display="none";
      document.getElementById("mainApp").style.display="block";
   }else{
      document.getElementById("login-msg").innerText="Sai SSID hoặc mật khẩu!";
   }
}
function logout(){
   localStorage.removeItem("logged");
   location.reload();
}
window.onload = ()=>{
   if(localStorage.getItem("logged")==="1"){
      document.getElementById("loginScreen").style.display="none";
      document.getElementById("mainApp").style.display="block";
   }
};

// Firebase config
const firebaseConfig = {
   apiKey: "AIzaSyBK3nLehgMJYXVHdEtWt7YwWifGYHm7fig",
   authDomain: "esp8266-dhnt2025.firebaseapp.com",
   databaseURL: "https://esp8266-dhnt2025-default-rtdb.asia-southeast1.firebasedatabase.app",
   projectId: "esp8266-dhnt2025"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const device = "esp01";
let lastCmdId = 0;
const ONLINE_TIMEOUT = 45000; // 45 giây, lớn hơn thời gian gửi heartbeat từ ESP (30s)
const controlButtons = document.querySelectorAll('.actions button:not(.btn-outline)');
const statusEl = document.getElementById("status");

// Khai báo biến onlineTimer ở đây để nó có phạm vi toàn cục
     let onlineTimer;  
// Hàm để vô hiệu hóa/kích hoạt các nút và cập nhật trạng thái
function toggleUI(online) {
   statusEl.innerText = online ? "Online" : "Offline";
   statusEl.className = "badge " + (online ? "online" : "offline");
   controlButtons.forEach(btn => {
      btn.disabled = !online;
   });
}

// Lắng nghe sự thay đổi của trạng thái online/offline từ ESP
db.ref("presence/" + device + "/online").on("value", snap => {
   const lastHeartbeat = snap.val() || 0;
   const isOnline = (Date.now() - lastHeartbeat) < ONLINE_TIMEOUT;

   // Cập nhật UI ngay lập tức
   toggleUI(isOnline);

   // Xóa timer cũ nếu có và thiết lập timer mới
   clearTimeout(onlineTimer);
   onlineTimer = setTimeout(() => {
      toggleUI(false);
   }, Math.max(0, ONLINE_TIMEOUT - (Date.now() - lastHeartbeat)));
});


// Lắng nghe các thay đổi khác
// === CẢI THIỆN LỖI ĐỒNG BỘ lastCmdId ===
db.ref("status/" + device).on("value", snap => {
   const s = snap.val() || {};
   const pumpEl = document.getElementById("pump");
   const modeEl = document.getElementById("mode");

   pumpEl.innerText = s.pump === true ? "ON" : "OFF";
   modeEl.innerText = s.mode || "-";

   pumpEl.className = "badge " + (s.pump === true ? "on" : "off");
   modeEl.className = "badge " + ((s.mode || "").toLowerCase());

   // Đồng bộ lastCmdId mỗi khi có thay đổi trên Firebase
   if (s.lastCmdId != null) {
      lastCmdId = s.lastCmdId;
   }
});

// XÓA listener cũ cho /sensors/ vì giờ chúng ta sẽ đọc dữ liệu từ /logs/
// db.ref("sensors/" + device).on("value", snap => { ... });

db.ref("logs/" + device).limitToLast(20).on("value", snap => {
   const logs = snap.val() || {};
   const tbody = document.getElementById("logTable");
   tbody.innerHTML = "";

   const logArray = Object.keys(logs).map(k => ({ ts: k, ...logs[k] }));
   logArray.sort((a,b) => b.ts - a.ts);

   // Lấy bản ghi log mới nhất để cập nhật bảng điều khiển chính
   if (logArray.length > 0) {
      const latestLog = logArray[0];
      document.getElementById("temp").innerText = latestLog.temp ?? "-";
      document.getElementById("hum").innerText = latestLog.hum ?? "-";
      document.getElementById("soil").innerText = latestLog.soil ?? "-";
   } else {
      document.getElementById("temp").innerText = "-";
      document.getElementById("hum").innerText = "-";
      document.getElementById("soil").innerText = "-";
   }

   logArray.forEach(log => {
      const date = new Date(log.ts * 1000);
      const dateStr = date.toLocaleString("vi-VN", { hour12: false });
      const row = document.createElement("tr");
      row.innerHTML = `
         <td>${dateStr}</td>
         <td>${log.temp ?? "-"}</td>
         <td>${log.hum ?? "-"}</td>
         <td>${log.soil ?? "-"}</td>
         <td>${log.pump ?? "-"}</td>
         <td>${log.mode ?? "-"}</td>
         <td>${log.note ?? "-"}</td>
      `;
      tbody.appendChild(row);
   });

   if (logArray.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7'>No logs</td></tr>";
   }
});
function sendCmd(pumpState) {
     // Tăng lastCmdId trước khi gửi lệnh
     lastCmdId++;
     db.ref("command/" + device).set({
        cmdId: lastCmdId,
        pump: pumpState,
        mode: "Manual"
     }).catch(err => console.error("Firebase write error:", err));
}
function setMode(modeState) {
     // Tăng lastCmdId trước khi gửi lệnh
     lastCmdId++;
     db.ref("command/" + device).set({
        cmdId: lastCmdId,
        pump: "",
        mode: modeState
     }).catch(err => console.error("Firebase write error:", err));
}
function exportLogCSV() {
     const logsRef = db.ref("logs/" + device);
     logsRef.once("value").then(snap => {
        const logs = snap.val() || {};
        let csv = "Time;Temp;Hum;Soil;Pump;Mode;Note\n";
        Object.keys(logs).sort().forEach(ts => {
           const log = logs[ts];
           const date = new Date(ts * 1000).toLocaleString("vi-VN",{hour12:false});
           csv += `${date};${log.temp ?? "-"};${log.hum ?? "-"};${log.soil ?? "-"};${log.pump ?? "-"};${log.mode ?? "-"};${log.note ?? "-"}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ESP_logs_${device}.csv`;
        link.click();
     }).catch(err => console.error(err));
}

// === Logic biểu đồ được tích hợp vào đây ===
let myChart = null;

// Thêm dòng này để đặt màu mặc định cho tất cả chữ trong biểu đồ
Chart.defaults.color = '#eaf0ff';

db.ref("logs/" + device).on("value", snap => {
     const logs = snap.val() || {};
     const logArray = Object.keys(logs).map(k => ({ ts: k, ...logs[k] }));

     // Tạo nhãn (mốc 30 phút)
     const labels = Array.from({ length: 48 }, (_, i) => {
        const h = Math.floor(i / 2);
        const m = (i % 2) * 30;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
     });

     const tempData = new Array(labels.length).fill(null);
     const humData = new Array(labels.length).fill(null);
     const soilData = new Array(labels.length).fill(null);

     const now = new Date();
     const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).getTime();

     logArray.forEach(log => {
        const logTime = log.ts * 1000;
        if (logTime >= todayStart && logTime <= now.getTime()) {
           const date = new Date(logTime);
           let hour = date.getHours();
           let minute = date.getMinutes();
           let minuteRounded = Math.floor(minute / 30) * 30;
           const labelIndex = (hour * 2) + (minuteRounded / 30);

           if (labelIndex < labels.length) {
              // Ép tất cả giá trị về thang 0–100
              let temp = log.temp ?? 0;
              if (temp > 100) temp = 100;
              if (temp < 0) temp = 0;
              tempData[labelIndex] = temp;

              let hum = log.hum ?? 0;
              hum = Math.max(0, Math.min(100, hum));
              humData[labelIndex] = hum;

              const soilValue = log.soil ?? 0;
              soilData[labelIndex] = soilValue;
           }
        }
     });

     if (myChart) {
        myChart.data.labels = labels;
        myChart.data.datasets[0].data = tempData;
        myChart.data.datasets[1].data = humData;
        myChart.data.datasets[2].data = soilData;
        myChart.update();
     } else {
        const ctx = document.getElementById('dailyChart').getContext('2d');
        myChart = new Chart(ctx, {
           type: 'line',
           data: {
              labels: labels,
              datasets: [
                 {
                    label: 'Nhiệt độ (°C)',
                    data: tempData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgb(255, 99, 132)',
                    tension: 0.2
                 },
                 {
                    label: 'Độ ẩm không khí (%)',
                    data: humData,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgb(54, 162, 235)',
                    tension: 0.2
                 },
                 {
                    label: 'Độ ẩm đất (%)',
                    data: soilData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgb(75, 192, 192)',
                    tension: 0.2
                 }
              ]
           },
           options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                 legend: { 
                    position: 'top',
                    labels: {
                       color: '#eaf0ff' // Đặt màu chữ cho chú thích
                    }
                 },
                 tooltip: { mode: 'index', intersect: false }
              },
              interaction: { mode: 'nearest', axis: 'x', intersect: false },
              scales: {
                 x: {
                    grid: {
                       color: 'rgba(255,255,255,.08)'
                    },
                    title: { 
                       display: true, 
                       text: 'Thời gian trong ngày',
                       color: '#eaf0ff' // Đặt màu chữ cho tiêu đề trục x
                    },
                    ticks: { 
                       color: '#eaf0ff', // Đặt màu chữ cho các giá trị trên trục x
                       autoSkip: true, 
                       maxTicksLimit: 24 
                    }
                 },
                 y: {
                    grid: {
                       color: 'rgba(255,255,255,.08)'
                    },
                    min: 0,
                    max: 100,
                    title: { 
                       display: true, 
                       text: 'Giá trị (%)',
                       color: '#eaf0ff' // Đặt màu chữ cho tiêu đề trục y
                    },
                    ticks: { 
                       color: '#eaf0ff' // Đặt màu chữ cho các giá trị trên trục y
                    }
                 }
            }
         }
        });
     }
});

// START: Phần thêm mới cho thanh trượt
const lowThreshSlider = document.getElementById("lowThreshSlider");
const highThreshSlider = document.getElementById("highThreshSlider");
const lowThreshValue = document.getElementById("lowThreshValue");
const highThreshValue = document.getElementById("highThreshValue");

// Lắng nghe sự thay đổi của slider và cập nhật Firebase
lowThreshSlider.addEventListener('input', (event) => {
    // Kiểm tra và điều chỉnh giá trị ngay lập tức
    const lowVal = parseInt(event.target.value);
    const highVal = parseInt(highThreshSlider.value);
    if (lowVal > highVal) {
        event.target.value = highVal;
    }
    lowThreshValue.innerText = event.target.value;
    db.ref("thresholds/" + device + "/low").set(parseInt(event.target.value)).catch(err => console.error(err));
});

highThreshSlider.addEventListener('input', (event) => {
    // Kiểm tra và điều chỉnh giá trị ngay lập tức
    const lowVal = parseInt(lowThreshSlider.value);
    const highVal = parseInt(event.target.value);
    if (highVal < lowVal) {
        event.target.value = lowVal;
    }
    highThreshValue.innerText = event.target.value;
    db.ref("thresholds/" + device + "/high").set(parseInt(event.target.value)).catch(err => console.error(err));
});

// Lắng nghe thay đổi từ Firebase và cập nhật giao diện
db.ref("thresholds/" + device).on("value", snap => {
   const thresholds = snap.val() || {};
   if (thresholds.low != null) {
      lowThreshSlider.value = thresholds.low;
      lowThreshValue.innerText = thresholds.low;
   }
   if (thresholds.high != null) {
      highThreshSlider.value = thresholds.high;
      highThreshValue.innerText = thresholds.high;
   }
});
// END: Phần thêm mới cho thanh trượt
</script>
</body>
</html>
